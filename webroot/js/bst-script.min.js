class l{mergeConfig(e,t){const n=a=>a&&typeof a=="object"&&!Array.isArray(a),i={...e};for(const a in t)if(t.hasOwnProperty(a)){const o=i[a],s=t[a];n(o)&&n(s)?i[a]=this.mergeConfig(o,s):i[a]=s!==void 0?s:o}return i}executeScripts(e){e.querySelectorAll("script").forEach(t=>{const n=document.createElement("script");n.textContent=t.textContent,t.parentNode.replaceChild(n,t)})}dispatchEvent(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t}))}}class d extends l{constructor(e,t={}){var i,a;super();const n={autoLoad:!0,csrfToken:null,form:{autoRender:!0,onSuccess:null,onError:null},links:{enabled:!0,bypassAttribute:"data-ajax-bypass",updateHistory:!1}};this.config=this.mergeConfig(n,t),this.container=e,this.initialUrl=((a=(i=this.container)==null?void 0:i.dataset)==null?void 0:a.url)||null,this.currentUrl=this.initialUrl,this.boundHandleLinkClick=this.handleLinkClick.bind(this),this.boundHandleFormSubmit=this.handleFormSubmit.bind(this),this.initialize()}initialize(){this.config.autoLoad&&this.initialUrl&&this.loadContent(this.initialUrl),this.config.links.enabled&&this.container.addEventListener("click",this.boundHandleLinkClick),this.attachForms()}async loadContent(e){try{this.dispatchEvent("bst:container-ajax:load",{url:e,container:this.container});const t=await fetch(e,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error(`HTTP Error ${t.status}`);this.currentUrl=e,this.config.links.updateHistory&&window.history.pushState({containerUrl:e},"",e);const n=await t.text();this.updateContainer(n),this.dispatchEvent("bst:container-ajax:loaded",{data:n,container:this.container})}catch(t){this.handleError(t),this.dispatchEvent("bst:container-ajax:error",{error:t.message,container:this.container})}}async handleFormSubmit(e){var n,i,a,o;e.preventDefault();const t=e.target;this.dispatchEvent("bst:container-ajax:form-submit",{form:t,container:this.container});try{const s=await fetch(t.action,{method:t.method,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html, text/plain","X-CSRF-Token":this.config.csrfToken},body:new FormData(t)}),r=await this.processFormResponse(s);this.config.form.autoRender&&this.updateContainer(r.html),this.dispatchEvent("bst:container-ajax:form-success",{data:r,form:t,container:this.container,response:s}),(i=(n=this.config.form).onSuccess)==null||i.call(n,r)}catch(s){this.handleFormError(s,t),this.dispatchEvent("bst:container-ajax:form-error",{error:s.message,form:t,container:this.container}),(o=(a=this.config.form).onError)==null||o.call(a,s)}}async processFormResponse(e){const t=e.headers.get("Content-Type")||"";let n={html:"",success:e.ok};if(!e.ok)throw new Error(`HTTP Error ${e.status}: ${e.statusText}`);if(t.includes("application/json")){const i=await e.json();n.html=i.html||"",n.success=i.success||!1}else t.includes("text/html")&&(n.html=await e.text());return n}handleFormError(e,t){const n=this.container;n.innerHTML=`
        <div class="alert alert-danger">
          ${e.message||"Error processing form submission"}
        </div>
      `}attachForms(e=this.container){e.querySelectorAll("form").forEach(t=>{t.removeEventListener("submit",this.boundHandleFormSubmit),t.addEventListener("submit",this.boundHandleFormSubmit),t.submit.bind(t),t.submit=()=>{this.handleFormSubmit(new Event("submit"))}})}handleLinkClick(e){const t=e.target.closest("a");if(!t)return;const n=t.href;t.hasAttribute(this.config.links.bypassAttribute)||!this.isSameOrigin(n)||this.isFragmentLink(t)||(e.preventDefault(),this.loadContent(n))}updateContainer(e){this.container.innerHTML=e,this.executeScripts(this.container),this.attachForms(this.container)}isSameOrigin(e){try{return new URL(e).origin===window.location.origin}catch{return!1}}isFragmentLink(e){const t=e.getAttribute("href");return!t||t.startsWith("#")}handleError(e){console.error("Container Error:",e),this.container.innerHTML=`
        <div class="alert alert-danger">
          ${e.message||"Error loading content"}
        </div>
      `}reload(){this.initialUrl&&this.loadContent(this.initialUrl)}}class h extends l{constructor(e){super();const t={target:"ajax-modal",modal:{title:".modal-title",body:".modal-body",closeOnSuccess:!1,reloadPageOnClose:!1},containerAjaxConfig:{autoLoad:!1,links:{enabled:!0,updateHistory:!1},form:{autoRender:!0}},csrfToken:null};this.config=this.mergeConfig(t,e),this.modal=document.getElementById(this.config.target),this.containerAjax=this.initContainerAjax(),this.shouldReloadPageOnClose=!1,this.init()}initContainerAjax(){const e=this.modal.querySelector(this.config.modal.body);return new d(e,{...this.config.containerAjaxConfig,csrfToken:this.config.csrfToken,onFormSuccess:t=>this.handleFormSuccess(t)})}init(){this.bindModalEvents(),this.bindContainerEvents()}bindModalEvents(){this.modal.addEventListener("show.bs.modal",e=>{var n,i;const t=(i=(n=e.relatedTarget)==null?void 0:n.dataset)==null?void 0:i.url;t&&this.loadContent(t)}),this.modal.addEventListener("hidden.bs.modal",()=>{this.config.modal.reloadPageOnClose&&this.shouldReloadPageOnClose&&window.location.reload()})}bindContainerEvents(){this.containerAjax.container.addEventListener("containerAjaxLoaded",e=>{const t=e.detail.data.title||this.extractTitle(e.detail.data.html);t&&this.updateModalTitle(t)})}async loadContent(e){this.dispatchEvent("modalAjaxLoad",{url:e,modal:this.modal}),await this.containerAjax.loadContent(e)}handleFormSuccess(e){var t;this.shouldReloadPageOnClose=!0,this.config.modal.closeOnSuccess&&((t=bootstrap.Modal.getInstance(this.modal))==null||t.hide())}updateModalTitle(e){this.modal.querySelector(this.config.modal.title).textContent=e}extractTitle(e){var n;const t=document.createElement("div");return t.innerHTML=e,(n=t.querySelector("h1"))==null?void 0:n.textContent}}window.ContainerAjax=d;window.ModalAjaxManager=h;
