class s{static mergeConfig(t,e){return{...t,...e}}executeScripts(t){t.querySelectorAll("script").forEach(e=>{const i=document.createElement("script");i.textContent=e.textContent,e.parentNode.replaceChild(i,e)})}dispatchEvent(t,e){document.dispatchEvent(new CustomEvent(t,{detail:e}))}}class a extends s{constructor(t,e={}){super();const i={autoRender:!0,target:t.closest(".form-container")||document.body,csrfToken:null,onSuccess:null,onError:null};typeof i.target=="string"&&(i.target=document.querySelector(i.target)),this.config=s.mergeConfig(i,e),this.form=t,this.boundHandleSubmit=this.handleSubmit.bind(this),this.init()}init(){this.bindEvents()}bindEvents(){this.form&&this.form.addEventListener("submit",this.boundHandleSubmit)}updateTarget(t){this.form&&this.form.removeEventListener("submit",this.boundHandleSubmit),this.config.target.innerHTML=t,this.form=this.config.target.querySelector("form"),this.form||console.warn("New HTML does not contain a form"),this.bindEvents()}async handleSubmit(t){t.preventDefault(),this.dispatchEvent("formAjaxSubmit",{form:this.form});let e;try{e=await fetch(this.form.action,{method:this.form.method,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html, text/plain","X-CSRF-Token":this.config.csrfToken},body:new FormData(this.form)});const i=await this.processResponse(e);this.config.autoRender&&(this.updateTarget(i.html),this.executeScripts(this.config.target)),this.dispatchEvent("formAjaxSuccess",{data:i,form:this.form,target:this.config.target,response:e}),this.config.onSuccess&&this.config.onSuccess(i)}catch(i){this.handleError(i),this.dispatchEvent("formAjaxError",{error:i.message,form:this.form,target:this.config.target,response:e}),this.config.onError&&this.config.onError(i)}}async processResponse(t){const e=t.headers.get("Content-Type")||"";let i={html:"",success:t.ok};if(!t.ok)throw new Error(`HTTP Error ${t.status}: ${t.statusText}`);if(e.includes("application/json")){const o=await t.json();i.html=o.html||"",i.success=o.success||!1}else e.includes("text/html")&&(i.html=await t.text());return i}handleError(t){const e=t.message||"Error processing request";console.error("Form Error:",e),this.config.target.innerHTML=`<div class="alert alert-danger">${e}</div>`}}class r extends s{constructor(t){super();const e={target:"ajax-modal",modal:{title:".modal-title",body:".modal-body",closeOnSuccess:!1,reloadPageOnSuccess:!1,reloadPageOnClose:!1},form:{autoRender:!0,overwriteOnLoading:!1},csrfToken:null};let i=s.mergeConfig(e,t);i.modal={...e.modal,...t.modal||{}},i.form={...e.form,...t.form||{}},this.config=i,this.modal=document.getElementById(this.config.target),this.loading={title:this.modal.querySelector(this.config.modal.title).innerHTML,html:this.modal.querySelector(this.config.modal.body).innerHTML},this.shouldReloadPageOnClose=!1,this.init()}init(){this.bindEvents()}bindEvents(){this.modal.addEventListener("show.bs.modal",t=>{var i,o;this.shouldReloadPageOnClose=!1;const e=(o=(i=t.relatedTarget)==null?void 0:i.dataset)==null?void 0:o.url;e&&this.loadContent(e)}),this.modal.addEventListener("hidden.bs.modal",()=>{this.config.modal.reloadPageOnClose&&this.shouldReloadPageOnClose&&window.location.reload()})}async loadContent(t){try{this.dispatchEvent("modalAjaxLoad",{url:t,modal:this.modal}),this.startLoading();const e=await fetch(t,{headers:{"X-Requested-With":"XMLHttpRequest"}}),i=await this.processResponse(e);this.stopLoading(),this.updateModal(i),this.attachForms(),this.dispatchEvent("modalAjaxLoaded",{data:i,modal:this.modal})}catch(e){this.handleError(e)}}async processResponse(t){const e=t.headers.get("Content-Type");let i={title:"",html:""};if(e.includes("application/json")){const o=await t.json();i={...i,...o}}else e.includes("text/html")&&(i.html=await t.text(),i.title=t.headers.get("X-Modal-Title")||this.extractTitle(i.html)||this.config.title);return i}updateModal({title:t,html:e}){this.modal.querySelector(this.config.modal.title).innerHTML=t;const i=this.modal.querySelector(this.config.modal.body);i.innerHTML=e,this.executeScripts(i)}attachForms(){const t=this.modal.querySelector(this.config.modal.body);t.querySelectorAll("form").forEach(e=>{new a(e,{target:t,autoRender:this.config.form.autoRender,csrfToken:this.config.csrfToken,onSuccess:i=>{if(this.shouldReloadPageOnClose=!0,this.config.modal.closeOnSuccess){const o=bootstrap.Modal.getInstance(this.modal);o&&o.hide()}}})})}startLoading(){this.modal.classList.add("loading"),this.config.form.overwriteOnLoading&&(this.modal.querySelector(this.config.modal.title).innerHTML=this.loading.title,this.modal.querySelector(this.config.modal.body).innerHTML=this.loading.html)}stopLoading(){this.modal.classList.remove("loading")}extractTitle(t){const e=t.match(/<h1[^>]*>(.*?)<\/h1>/i);return e?e[1]:null}handleError(t){console.error("Modal Error:",t),this.updateModal({title:"Error",html:`<p>${t.message}</p>`})}}class l extends s{constructor(t,e={}){super();const i={autoLoad:!0,csrfToken:null,form:{autoRender:!0},links:{enabled:!0,bypassAttribute:"data-ajax-bypass",updateHistory:!1}};this.config=s.mergeConfig(i,e),this.container=t,this.initialUrl=this.container.dataset.url,this.currentUrl=this.initialUrl,this.boundHandleLinkClick=this.handleLinkClick.bind(this),this.config.autoLoad&&this.initialUrl&&this.loadContent(this.initialUrl),this.config.links.enabled&&this.container.addEventListener("click",this.boundHandleLinkClick)}async loadContent(t){try{this.dispatchEvent("containerAjaxLoad",{url:t,container:this.container});const e=await fetch(t,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!e.ok)throw new Error(`HTTP Error ${e.status}`);this.currentUrl=t,this.config.links.updateHistory&&window.history.pushState({containerUrl:t},"",t);const i=await e.text();this.updateContainer(i),this.attachForms(),this.dispatchEvent("containerAjaxLoaded",{data:i,container:this.container})}catch(e){this.handleError(e),this.dispatchEvent("containerAjaxError",{error:e.message,container:this.container})}}handleLinkClick(t){const e=t.target.closest("a");if(!e)return;const i=e.href;e.hasAttribute(this.config.links.bypassAttribute)||!this.isSameOrigin(i)||this.isFragmentLink(e)||(t.preventDefault(),this.loadContent(i))}isSameOrigin(t){try{return new URL(t).origin===window.location.origin}catch{return!1}}isFragmentLink(t){const e=t.getAttribute("href");return!e||e.startsWith("#")}updateContainer(t){this.container.innerHTML=t,this.executeScripts(this.container)}reload(){this.currentUrl&&this.loadContent(this.currentUrl)}attachForms(){this.container.querySelectorAll("form").forEach(t=>{new a(t,{target:this.container,autoRender:this.config.form.autoRender,csrfToken:this.config.csrfToken})})}handleError(t){console.error("Container Error:",t),this.container.innerHTML=`
            <div class="alert alert-danger">
                ${t.message||"Error loading content"}
            </div>
        `}}window.ContainerAjax=l;window.FormAjaxManager=a;window.ModalAjaxManager=r;
