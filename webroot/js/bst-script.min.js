class c{mergeConfig(t,e){const i=s=>s&&typeof s=="object"&&!Array.isArray(s),n={...t};for(const s in e)if(e.hasOwnProperty(s)){const r=n[s],o=e[s];i(r)&&i(o)?n[s]=this.mergeConfig(r,o):n[s]=o!==void 0?o:r}return n}executeScripts(t){t.querySelectorAll("script").forEach(e=>{const i=document.createElement("script");i.textContent=e.textContent,e.parentNode.replaceChild(i,e)})}dispatchEvent(t,e){document.dispatchEvent(new CustomEvent(t,{detail:e}))}}class l extends c{constructor(t,e={}){super();const i={autoRender:!0,target:t.closest(".form-container")||document.body,csrfToken:null,onSuccess:null,onError:null};typeof i.target=="string"&&(i.target=document.querySelector(i.target)),this.config=this.mergeConfig(i,e),this.config.target=e.target||t.closest(".form-container")||document.body,this.form=t,typeof this.config.target=="string"&&(this.config.target=document.querySelector(this.config.target)),this.boundHandleSubmit=this.handleSubmit.bind(this),this.init(),t.submit.bind(t),t.submit=()=>{this.handleSubmit(new Event("submit"))}}init(){this.bindEvents()}bindEvents(){this.form&&this.form.addEventListener("submit",this.boundHandleSubmit)}updateTarget(t){var e;this.form&&this.form.removeEventListener("submit",this.boundHandleSubmit),this.config.target.innerHTML=t,this.form=(e=this.config)==null?void 0:e.target.querySelector("form"),this.form||console.warn("New HTML does not contain a form"),this.bindEvents()}async handleSubmit(t){t.preventDefault(),this.dispatchEvent("formAjaxSubmit",{form:this.form});let e;try{e=await fetch(this.form.action,{method:this.form.method,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html, text/plain","X-CSRF-Token":this.config.csrfToken},body:new FormData(this.form)});const i=await this.processResponse(e);this.config.autoRender&&(this.updateTarget(i.html),this.executeScripts(this.config.target)),this.dispatchEvent("formAjaxSuccess",{data:i,form:this.form,target:this.config.target,response:e}),this.config.onSuccess&&this.config.onSuccess(i)}catch(i){this.handleError(i),this.dispatchEvent("formAjaxError",{error:i.message,form:this.form,target:this.config.target,response:e}),this.config.onError&&this.config.onError(i)}}async processResponse(t){const e=t.headers.get("Content-Type")||"";let i={html:"",success:t.ok};if(!t.ok)throw new Error(`HTTP Error ${t.status}: ${t.statusText}`);if(e.includes("application/json")){const n=await t.json();i.html=n.html||"",i.success=n.success||!1}else e.includes("text/html")&&(i.html=await t.text());return i}handleError(t){const e=t.message||"Error processing request";console.error("Form Error:",e),this.config.target.innerHTML=`<div class="alert alert-danger">${e}</div>`}}class h extends c{constructor(t,e={}){var n,s;super();const i={autoLoad:!0,csrfToken:null,form:{autoRender:!0},links:{enabled:!0,bypassAttribute:"data-ajax-bypass",updateHistory:!1}};this.config=this.mergeConfig(i,e),this.container=t,this.initialUrl=((s=(n=this.container)==null?void 0:n.dataset)==null?void 0:s.url)??null,this.currentUrl=this.initialUrl,this.boundHandleLinkClick=this.handleLinkClick.bind(this),this.config.autoLoad&&this.initialUrl&&this.loadContent(this.initialUrl),this.config.links.enabled&&this.container.addEventListener("click",this.boundHandleLinkClick)}async loadContent(t){try{this.dispatchEvent("containerAjaxLoad",{url:t,container:this.container});const e=await fetch(t,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!e.ok)throw new Error(`HTTP Error ${e.status}`);this.currentUrl=t,this.config.links.updateHistory&&window.history.pushState({containerUrl:t},"",t);const i=await e.text();this.updateContainer(i),this.attachForms(),this.dispatchEvent("containerAjaxLoaded",{data:i,container:this.container})}catch(e){this.handleError(e),this.dispatchEvent("containerAjaxError",{error:e.message,container:this.container})}}handleLinkClick(t){const e=t.target.closest("a");if(!e)return;const i=e.href;e.hasAttribute(this.config.links.bypassAttribute)||!this.isSameOrigin(i)||this.isFragmentLink(e)||(t.preventDefault(),this.loadContent(i))}isSameOrigin(t){try{return new URL(t).origin===window.location.origin}catch{return!1}}isFragmentLink(t){const e=t.getAttribute("href");return!e||e.startsWith("#")}updateContainer(t){this.container.innerHTML=t,this.executeScripts(this.container)}reload(){this.initialUrl&&this.loadContent(this.initialUrl)}attachForms(){this.container.querySelectorAll("form").forEach(t=>{new l(t,{target:this.container,autoRender:this.config.form.autoRender,csrfToken:this.config.csrfToken})})}handleError(t){console.error("Container Error:",t),this.container.innerHTML=`
            <div class="alert alert-danger">
                ${t.message||"Error loading content"}
            </div>
        `}}class d extends c{constructor(t){super();const e={target:"ajax-modal",modal:{title:".modal-title",body:".modal-body",closeOnSuccess:!1,reloadPageOnClose:!1},containerAjaxConfig:{autoLoad:!1,links:{enabled:!0,updateHistory:!1},form:{autoRender:!0}},csrfToken:null};this.config=this.mergeConfig(e,t),this.modal=document.getElementById(this.config.target),this.containerAjax=this.initContainerAjax(),this.shouldReloadPageOnClose=!1,this.init()}initContainerAjax(){const t=this.modal.querySelector(this.config.modal.body);return new h(t,{...this.config.containerAjaxConfig,csrfToken:this.config.csrfToken,onFormSuccess:e=>this.handleFormSuccess(e)})}init(){this.bindModalEvents(),this.bindContainerEvents()}bindModalEvents(){this.modal.addEventListener("show.bs.modal",t=>{var i,n;const e=(n=(i=t.relatedTarget)==null?void 0:i.dataset)==null?void 0:n.url;e&&this.loadContent(e)}),this.modal.addEventListener("hidden.bs.modal",()=>{this.config.modal.reloadPageOnClose&&this.shouldReloadPageOnClose&&window.location.reload()})}bindContainerEvents(){this.containerAjax.container.addEventListener("containerAjaxLoaded",t=>{const e=t.detail.data.title||this.extractTitle(t.detail.data.html);e&&this.updateModalTitle(e)})}async loadContent(t){this.dispatchEvent("modalAjaxLoad",{url:t,modal:this.modal}),await this.containerAjax.loadContent(t)}handleFormSuccess(t){var e;this.shouldReloadPageOnClose=!0,this.config.modal.closeOnSuccess&&((e=bootstrap.Modal.getInstance(this.modal))==null||e.hide())}updateModalTitle(t){this.modal.querySelector(this.config.modal.title).textContent=t}extractTitle(t){var i;const e=document.createElement("div");return e.innerHTML=t,(i=e.querySelector("h1"))==null?void 0:i.textContent}}window.ContainerAjax=h;window.FormAjaxManager=l;window.ModalAjaxManager=d;
