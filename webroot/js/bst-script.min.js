class t{static mergeConfig(t,e){return{...t,...e}}executeScripts(t){t.querySelectorAll("script").forEach((t=>{const e=document.createElement("script");e.textContent=t.textContent,t.parentNode.replaceChild(e,t)}))}dispatchEvent(t,e){document.dispatchEvent(new CustomEvent(t,{detail:e}))}}class e extends t{constructor(e,o={}){super();const s={autoRender:!0,target:e.closest(".form-container")||document.body,csrfToken:null,onSuccess:null,onError:null};"string"==typeof s.target&&(s.target=document.querySelector(s.target)),this.config=t.mergeConfig(s,o),this.form=e,this.boundHandleSubmit=this.handleSubmit.bind(this),this.init()}init(){this.bindEvents()}bindEvents(){this.form&&this.form.addEventListener("submit",this.boundHandleSubmit)}updateTarget(t){this.form&&this.form.removeEventListener("submit",this.boundHandleSubmit),this.config.target.innerHTML=t,this.form=this.config.target.querySelector("form"),this.form||console.warn("New HTML does not contain a form"),this.bindEvents()}async handleSubmit(t){let e;t.preventDefault(),this.dispatchEvent("formAjaxSubmit",{form:this.form});try{e=await fetch(this.form.action,{method:this.form.method,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html, text/plain","X-CSRF-Token":this.config.csrfToken},body:new FormData(this.form)});const t=await this.processResponse(e);this.config.autoRender&&(this.updateTarget(t.html),this.executeScripts(this.config.target)),this.dispatchEvent("formAjaxSuccess",{data:t,form:this.form,target:this.config.target,response:e}),this.config.onSuccess&&this.config.onSuccess(t)}catch(t){this.handleError(t),this.dispatchEvent("formAjaxError",{error:t.message,form:this.form,target:this.config.target,response:e}),this.config.onError&&this.config.onError(t)}}async processResponse(t){const e=t.headers.get("Content-Type")||"";let o={html:"",success:t.ok};if(!t.ok)throw new Error(`HTTP Error ${t.status}: ${t.statusText}`);if(e.includes("application/json")){const e=await t.json();o.html=e.html||"",o.success=e.success||!1}else e.includes("text/html")&&(o.html=await t.text());return o}handleError(t){const e=t.message||"Error processing request";console.error("Form Error:",e),this.config.target.innerHTML=`<div class="alert alert-danger">${e}</div>`}}window.FormAjaxManager=e,window.ModalAjaxManager=class extends t{constructor(e){super();const o={target:"ajax-modal",modal:{title:".modal-title",body:".modal-body",closeOnSuccess:!1,reloadPageOnSuccess:!1,reloadPageOnClose:!1},form:{autoRender:!0,overwriteOnLoading:!1},csrfToken:null};let s=t.mergeConfig(o,e);s.modal={...o.modal,...e.modal||{}},s.form={...o.form,...e.form||{}},this.config=s,this.modal=document.getElementById(this.config.target),this.loading={title:this.modal.querySelector(this.config.modal.title).innerHTML,html:this.modal.querySelector(this.config.modal.body).innerHTML},this.shouldReloadPageOnClose=!1,this.init()}init(){this.bindEvents()}bindEvents(){this.modal.addEventListener("show.bs.modal",(t=>{var e,o;this.shouldReloadPageOnClose=!1;const s=null==(o=null==(e=t.relatedTarget)?void 0:e.dataset)?void 0:o.url;s&&this.loadContent(s)})),this.modal.addEventListener("hidden.bs.modal",(()=>{this.config.modal.reloadPageOnClose&&this.shouldReloadPageOnClose&&window.location.reload()}))}async loadContent(t){try{this.dispatchEvent("modalAjaxLoad",{url:t,modal:this.modal}),this.startLoading();const e=await fetch(t,{headers:{"X-Requested-With":"XMLHttpRequest"}}),o=await this.processResponse(e);this.stopLoading(),this.updateModal(o),this.attachForms(),this.dispatchEvent("modalAjaxLoaded",{data:o,modal:this.modal})}catch(t){this.handleError(t)}}async processResponse(t){const e=t.headers.get("Content-Type");let o={title:"",html:""};if(e.includes("application/json")){const e=await t.json();o={...o,...e}}else e.includes("text/html")&&(o.html=await t.text(),o.title=t.headers.get("X-Modal-Title")||this.extractTitle(o.html)||this.config.title);return o}updateModal({title:t,html:e}){this.modal.querySelector(this.config.modal.title).innerHTML=t;const o=this.modal.querySelector(this.config.modal.body);o.innerHTML=e,this.executeScripts(o)}attachForms(){const t=this.modal.querySelector(this.config.modal.body);t.querySelectorAll("form").forEach((o=>{new e(o,{target:t,autoRender:this.config.form.autoRender,csrfToken:this.config.csrfToken,onSuccess:t=>{if(this.shouldReloadPageOnClose=!0,this.config.modal.closeOnSuccess){const t=bootstrap.Modal.getInstance(this.modal);t&&t.hide()}}})}))}startLoading(){this.modal.classList.add("loading"),this.config.form.overwriteOnLoading&&(this.modal.querySelector(this.config.modal.title).innerHTML=this.loading.title,this.modal.querySelector(this.config.modal.body).innerHTML=this.loading.html)}stopLoading(){this.modal.classList.remove("loading")}extractTitle(t){const e=t.match(/<h1[^>]*>(.*?)<\/h1>/i);return e?e[1]:null}handleError(t){console.error("Modal Error:",t),this.updateModal({title:"Error",html:`<p>${t.message}</p>`})}};
